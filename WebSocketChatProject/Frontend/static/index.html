<!DOCTYPE html>
<html lang="en">
<head>
    <title>WebSocket Chat</title>
</head>
<body>
    <div id="chat-container">
        <div id="chat_messages"></div>
        <input id="messageInput" type="text" placeholder="Type your message..." />
        <input id="fileInput" type="file" />
        <button id="sendButton">Send</button>
    </div>

    <script>
        const socket = new WebSocket("ws://localhost:8000/ws");
        const chatMessages = document.getElementById("chat_messages");
        const messageInput = document.getElementById("messageInput");
        const fileInput = document.getElementById("fileInput");
        const sendButton = document.getElementById("sendButton");

        socket.onmessage = (event) => {
            const message = event.data;
            if (message.toString().startsWith("data:image/png;base64,") ||
                message.toString().startsWith("data:image/jpeg;base64,") ||
                message.toString().startsWith("data:image/jpg;base64,") ||
                message.toString().startsWith("data:image/bmp;base64,") ||
                message.toString().startsWith("data:image/gif;base64,") ||
                message.toString().startsWith("data:image/tiff;base64,")
            ) {
                imgData = `<img src=${message} style="max-width: 300px;width: 100px;"/>`
                chatMessages.innerHTML += `<p>${imgData}</p>`;
            }
            else {
                chatMessages.innerHTML += `<p>${message}</p>`;
            }
        };

        sendButton.addEventListener("click", () => {
            const message = messageInput.value;
            const selectedFile = fileInput.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const fileData = event.target.result;
                    socket.send(fileData);
                    fetch('http://localhost:8000/send-message', {
                        method: 'POST',
                        headers: {
                            Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzA1MDM1OTgwLCJ1c2VyX2lkIjoxLCJqdGkiOiJaLXNYcGd2QjNnd3lYUVdDRm81RmhvaTljYzdKVHctaThKUW5kNUlObFFNIn0.bPWrgXED2pLSIDPD7SsVf-KS-MGE12F3cIZ_ICGY9KI',
                            accept: 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: fileData,
                            receiver: 1
                        })
                    })
                        .then(response=>response.json())
                        .then(res=>console.log(res))
                };
                reader.readAsDataURL(selectedFile);
                fileInput.value = ''
            }
            if (message) {
                socket.send(message);
                fetch('http://localhost:8000/send-message', {
                    method: 'POST',
                    headers: {
                        Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzA1MDM1OTgwLCJ1c2VyX2lkIjoxLCJqdGkiOiJaLXNYcGd2QjNnd3lYUVdDRm81RmhvaTljYzdKVHctaThKUW5kNUlObFFNIn0.bPWrgXED2pLSIDPD7SsVf-KS-MGE12F3cIZ_ICGY9KI',
                        accept: 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        receiver: 1
                    })
                })
                    .then(response=>response.json())
                    .then(res=>console.log(res))
                messageInput.value = "";
            }
        });
    </script>
</body>
</html>